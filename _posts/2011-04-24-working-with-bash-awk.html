---
title: "Working with Bash - awk"
layout: "post"
permalink: "/2011/04/working-with-bash-awk.html"
uuid: "6510363428141908448"
guid: "tag:blogger.com,1999:blog-4675781771561437973.post-6510363428141908448"
date: "2011-04-24 12:24:00"
updated: "2011-05-13 19:53:46"
description: 
blogger:
    siteid: "4675781771561437973"
    postid: "6510363428141908448"
categories: 
comments: true
---

{% raw %}
<div class="css-full-post-content js-full-post-content">
Now a quickie - one of my favorite tools: awk. &nbsp;Some of you will probably think of this as obvious, and that's great. &nbsp;But tools like awk are the things that I skipped learning when I got started... and when I finally started using them, my world expanded tremendously. &nbsp;Here's hoping I can pay it forward to one other sysadmin out there. &nbsp;So let's get going.<br /><br /><b>Awk</b><br /><b><br /></b><br />My first handy command is <i>awk</i>&nbsp;. This command lets you set a pattern to hunt for, and then an action to take every time it finds the pattern. &nbsp;Pattern, action. &nbsp;And that's the format on the command line:<br /><blockquote>awk pattern {action}</blockquote>If you omit the pattern, it takes the action on every line. &nbsp;It also automatically considers the input as a series of fields, and assigns them variables for you: $1 is the first field, $2 is the second, and so on. &nbsp;$0 is the whole line.<br /><br />One really common usage (and the one I was looking for today) is to just print a single column. &nbsp;In my case, I wanted to get a list of file sizes in a directory. So I used<br /><blockquote>ls -l | awk '{print $5}'</blockquote>Actions can be pretty impressive - you can use if/then, do/while, and other simple constructs. &nbsp;You can even stack awk pattern/action constructs by separating them with a semicolon.<br /><br />So now I'm on a quest to do as much as possible with this one command. I'm going to change my initial requirements: what if the directory I'm listing has subdirectories? &nbsp;I want to make sure to exclude those from my filesize list. &nbsp;So now I get to play with the "pattern" part of awk.<br /><blockquote>ls -l | awk '/^-/ {print $5}'</blockquote>Note the forward slashes which denote the text to search for. In this case it's ^- , meaning a newline followed immediately by a -. <br /><br />Now actually, the whole point of this exercise was to get the sum total size of the files in this directory. &nbsp;So let's make awk do that for us. &nbsp;The first thing to learn is that awk can do math. &nbsp;If you have a series of numbers on one line, you can say<br /><blockquote>awk '{ sum = $1 + $2 + $3} {print sum}'</blockquote>And end up with a sum of the 3 numbers for each line in the input. &nbsp;If you want to do math across lines, you have to use stored variables. &nbsp;It's simple to say '{ sum = $5 }'. &nbsp;But if you want each line to add it's $5 to 'sum', you simply use '{ sum += $5 }' . &nbsp;We could just as easily have any other operator in there, it works just as well with -= , *= , /= etc. &nbsp; Of course, in this case what we really care about is the sum of all the filesizes, so let's update our command:<br /><blockquote>ls -l | awk '/^-/ { sum += $5 } {print sum}'</blockquote>Now for each line of the input, it will spit out whatever the current file size tally is, adding $5 to it when the regular expression ^- matches. Actually, that's pretty unreadable, so let's add another simple math operator in there to show this in megabytes:<br /><blockquote>ls -l | awk '/^-/ { sum += $5 / 1048576 } {print sum, "M" }'</blockquote>Don't feel bad if you don't have the number of bytes in a megabyte memorized - I have to run to my calculator every time for 1024 * 1024. &nbsp;I should have just included it in the expression, come to think of it...<br /><br />This is pretty sweet so far, and more than enough to get me the information I wanted. &nbsp;But let's polish it a little more - that stupid list bothers me, since all I really care about is the last value. &nbsp;Now we're going to take advantage of&nbsp;BEGIN and END, which tell awk to do something before the first line of the input, or after the last line, respectively. <br /><br /><blockquote>ls -l | awk '/^-/ { sum += $5 / (1024 * 1024) } END { print "This directory contains ", sum, "M of files." }'</blockquote>Pretty sweet! &nbsp;Right there, I just saved myself a lot of swearing.
</div>
{% endraw %}
